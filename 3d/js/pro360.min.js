function pad(a,b){for(var c="",d=0;d<b;d++)c+="0";return(c+a).slice(-1*b)}var PRO360=function(){function b(a){this.Config=a,this.preloader,this.stage,this.layer,this.image,this.images=[],this.loadedImages={},this.rotatingMode,this.zoomMode,this.globalInterval,this.normalView,this.zoomView,this.originalZoomView,this.init()}function d(a){var b=a.Config;if("cross"==b.type){for(var c=b.minX;c<b.maxX;c++)a.images.push(f(a,c,b.startY,b));for(var c=b.minY;c<b.maxY;c++)a.images.push(f(a,b.startX,c,b))}else if("rect"==b.type)for(var c=b.minX;c<b.maxX;c++)for(var d=b.minY;d<b.maxY;d++)a.images.push(f(a,c,d,b));else if("row"==b.type||void 0===b.type)for(var c=b.minX;c<b.maxX;c++)a.images.push(f(a,c,0,b));var e=g(a,b.startX,b.startY,b),h=new Image;h.src=e,n(a),h.onload=function(c){a.loadedImages[e]=h,a.render(b.startX,b.startY)};var i=[],j=[];if("1row"==b.preload)for(var c=0,l=a.images.length;c<l;c++){var o=a.images[c];o.y==b.startY?i.push(o):j.push(o)}else i=a.images;new Preloader(b.containerSelector,_.pluck(i,"src"),function(b,c){if(!c||0==c.length){for(var d=0,e=i.length;d<e;d++){var f=new Image;f.src=i[d].src,a.loadedImages[i[d].src]=f}if(k(a),m(a),j.length){new Preloader(null,_.pluck(j,"src"),function(b,c){for(var d=0,e=j.length;d<e;d++){var f=new Image;f.src=j[d].src,a.loadedImages[j[d].src]=f}})}}})}function e(a){var b=function(a){a.rotation&&"wait"==a.rotation.status&&a.zoom(),a.rotation=null,document.removeEventListener("mouseup",a.globalHandler)};a.stage.on("contentMousedown contentTouchstart",function(c){a.globalHandler=_.bind(b,a,a),document.addEventListener("mouseup",a.globalHandler);var d=a.zoomMode;d&&a.zoom(!1);var e=a.stage.getPointerPosition();a.rotation={status:d?"unzoom":"wait",startPoint:e,lastPoint:e},a.pause()}),a.stage.on("contentTouchend",function(c){b(a)}),a.stage.on("contentMousemove contentTouchmove",function(b){if(a.zoomMode&&!a.rotation){var c=a.stage.getPointerPosition(),d=a.originalZoomView,e=a.normalView;return a.zoomView.x=d.x-Math.min((c.x-a.view.width/2)/(e.width/2),1)*(d.width-e.width)/2,a.zoomView.y=d.y-Math.min((c.y-a.view.height/2)/(e.height/2),1)*(d.height-e.height)/2,void a.renderRel(0,0)}if(a.rotation){var c=a.stage.getPointerPosition(),f=c.x-a.rotation.lastPoint.x,g=-1*(c.y-a.rotation.lastPoint.y);if(!("wait"==a.rotation.status&&Math.abs(f)<4&&Math.abs(g)<4)){a.rotation.status="rotation";var h=a.Config,i=a.image.width()/h.maxX>>0,j=a.image.height()/2/h.maxY>>0,k=!1,l=!1;switch(h.type){case"row":k=!0,l=!1;break;case"col":k=!1,l=!0;break;case"cross":l=a.currentFrameX==h.startX,k=a.currentFrameY==h.startY;break;case"rect":k=!0,l=!0}i=k&&Math.abs(f)>i?-f/i>>0:0,j=l&&Math.abs(g)>j?-g/j>>0:0,0==i&&0==j||(a.renderRel(k?i:0,l?j:0),a.rotation.lastPoint={x:i?c.x:a.rotation.lastPoint.x,y:j?c.y:a.rotation.lastPoint.y})}}}),a.stage.on("contentDblclick contentDblTap",function(a){})}function f(a,b,c,d){return{x:b,y:c,src:g(a,b,c,d)}}function g(a,b,c,d){var e;if(d.file.fn)e=d.file.fn(b,c);else{var e=d.file.tpl.replace("{X}",("0000000"+b).slice(-d.file.xwidth));e=e.replace("{Y}",("0000000"+c).slice(-d.file.ywidth))}var f=a.zoomMode?d.zoomfolder:d.folder;return f+e}function h(b){b.Config||(b.Config={});for(var c in a)void 0===b.Config[c]&&(b.Config[c]=a[c]);if("function"==typeof b.Config.file)b.Config.file={fn:b.Config.file};else{var d=b.Config.file;b.Config.file={tpl:d};var e=d?d.match(/{(X+)}/):null;e&&(b.Config.file.xwidth=e[1].length,b.Config.file.tpl=b.Config.file.tpl.replace(/{(X+)}/,"{X}"));var f=d?d.match(/{(Y+)}/):null;f&&(b.Config.file.ywidth=f[1].length,b.Config.file.tpl=b.Config.file.tpl.replace(/{(Y+)}/,"{Y}"))}b.currentFrameX=b.Config.startX,b.currentFrameY=b.Config.startY}function i(a){var b=a.Config,c=!1,d=!1;switch(b.type){case"row":c=!0,d=!1;break;case"col":c=!1,d=!0;break;case"cross":d=a.currentFrameX==b.startX,c=a.currentFrameY==b.startY;break;case"rect":c=!0,d=!0}return{canMoveX:c,canMoveY:d}}function j(a,b,c){var d=document.createElement("div");if(d.className="pro360-"+b,c.appendChild(d),"zoom"==b)return void d.addEventListener("click",function(){a.pause(),a.zoom()});if("play"==b)return void d.addEventListener("click",function(){a.globalInterval?a.pause():a.play()});var e="up"==b||"down"==b?0:"left"==b?-1:1,f="left"==b||"right"==b?0:"down"==b?-1:1,g=function(){a.pause(),clearInterval(a.globalInterval),a.renderRel(e,f),a.globalInterval=setInterval(function(){a.renderRel(e,f)},100)},h=function(){a.pause()};return d.addEventListener("mousedown",g),d.addEventListener("touchstart",g),d.addEventListener("mouseup",h),d.addEventListener("mouseleave",h),d.addEventListener("touchend",h),d}function k(a){if(!a.toolbox){var b=document.querySelector(a.Config.containerSelector+"-toolbox");if(null!=b){b.addEventListener("mouseenter",function(){a.zoomView.x=a.originalZoomView.x,a.zoomView.y=a.originalZoomView.y,a.renderRel(0,0)}),btns=document.createElement("div"),btns.className="pro360-rotatebuttons",b.appendChild(btns),a.toolbox={};for(var c=["up","left","right","down","play"],d=0,e=c.length;d<e;d++)a.toolbox[c[d]]=j(a,c[d],btns)}}}function l(a,b,c,d){for(void 0===b&&(b=a.currentFrameX);b<d.minX;)b=d.allow360X?d.maxX-1+b:d.minX;for(;b>=d.maxX;)b=d.allow360X?b-d.maxX+1:d.maxX-1;for(void 0===c&&(c=a.currentFrameY);c<d.minY;)c=d.allow360Y?d.maxY-1+c:d.minY;for(;c>=d.maxY;)c=d.allow360Y?c-d.maxY+1:d.maxY-1;switch(d.type){case"cross":b!=d.startX&&c!=d.startY&&(Math.abs(b-d.startX)<Math.abs(c-d.startY)?b=d.startX:c=d.startY);break;case"row":c!=d.startY&&(c=d.startY);break;case"col":b!=d.startX&&(b=d.startX);break;case"rect":}a.currentFrameX=b,a.currentFrameY=c}function m(a){a.Config.autoplay&&a.play(!0)}function n(a){var b=document.querySelector(a.Config.containerSelector),c=b.clientWidth,d=b.clientHeight;a.view={width:c,height:d};a.stage=new Konva.Stage({container:b,width:c,height:d,listening:!0}),a.layer=new Konva.Layer;var g=0,h=c-2*g,i=d-2*g,j=a.Config.width/a.Config.height,k=h,l=h/j;l>i&&(l=i,k=j*i),a.normalView={x:(c-k)/2,y:(d-l)/2,width:k,height:l};var m=a.Config.zoomfactor?a.Config.zoomfactor:4;a.originalZoomView={x:(c-k*m)/2,y:(d-l*m)/2,width:k*m,height:l*m},a.zoomView={x:(c-k*m)/2,y:(d-l*m)/2,width:k*m,height:l*m},a.image=new Konva.Image({x:(c-k)/2,y:(d-l)/2,width:k,height:l}),a.layer.add(a.image),a.stage.add(a.layer),e(a),a.currentFrameY=a.Config.startY||a.Config.minY,a.render(),window.onresize=function(){n(a)}}var a={file:"XXX-YYY.jpg",startX:0,startY:0,minDelta:15,allow360:!1,maxY:1,maxX:1,minX:0,minY:0,type:"row",containerSelector:".pro360",preload:"1row"},c=b.prototype;return c.pause=function(){clearInterval(this.globalInterval),this.globalInterval=0;var a=document.querySelector(".pro360-play");a&&(a.className="pro360-play")},c.play=function(){var a=this;void 0===a.forward&&(a.forward=!0);var b=document.querySelector(".pro360-play");b&&(b.className="pro360-play pause"),a.pause(),clearInterval(a.globalInterval),a.globalInterval=setInterval(function(){if(a.Config.autoplay&&a.Config.autoplay.bounce)a.currentFrameX!=a.Config.minX&&a.currentFrameX!=a.Config.maxX-1||(a.forward=!a.forward);else if(a.currentFrameX==a.Config.maxX-1)return void a.render(a.Config.minX,a.currentFrameY);a.renderRel(a.forward?1:-1,0)},a.Config.autoplay.interval)},c.initViewport=function(){n(this)},c.init=function(a){h(this),d(this)},c.render=function(a,b){var c=this.Config;l(this,a,b,c);var f,h=g(this,this.currentFrameX,this.currentFrameY,this.Config);this.zoomMode?(f=new Image,f.src=h):f=this.loadedImages[h];var i=this;void 0===this.frameCounter?this.frameCounter=0:this.frameCounter++;var j=this.frameCounter,k=i.zoomMode&&i.zoomView?i.zoomView:i.normalView,m={x:k.x,y:k.y,width:k.width,height:k.height,timing:Date.now()},n=i.image.getAttrs(),o={x:n.x,y:n.y,width:n.width,height:n.height},p=m.width!=k.width;p?(Math.abs(k.x-o.x)+Math.abs(k.y-o.y))/100:.5;k.x==o.x&&k.y==o.y&&k.width==o.width&&k.height==o.height||TweenLite.to(o,p?.7:.3,{x:k.x,y:k.y,width:k.width,height:k.height,ease:p?Sine.easeInOut:Linear.easeNone,onUpdate:function(){i.image.setAttrs(o),i.layer.batchDraw()}}),this.zoomMode?f.onload=function(a){j<i.frameCounter||(i.image.setImage(f),i.layer.draw())}:(i.image.setImage(f),i.layer.draw(),this.renderToolbox())},c.renderRel=function(a,b){this.currentFrameX+=void 0===a?1:a,this.currentFrameY+=void 0===b?1:b,this.render(this.currentFrameX,this.currentFrameY)},c.zoom=function(a){void 0===a?this.zoomMode=!this.zoomMode:this.zoomMode=a,this.rotatingMode=!1,this.zoomView.x=this.originalZoomView.x,this.zoomView.y=this.originalZoomView.y,this.renderRel(0,0)},c.renderToolbox=function(){var a=i(this);this.toolbox&&(a.canMoveX?(this.toolbox.left.style.display="",this.toolbox.right.style.display=""):(this.toolbox.left.style.display="none",this.toolbox.right.style.display="none"),a.canMoveY?(this.toolbox.up.style.display="",this.toolbox.down.style.display=""):(this.toolbox.up.style.display="none",this.toolbox.down.style.display="none"))},b}();